- id: '1702816490900'
  alias: 'Varsel: Lavt batteri på enheter'
  description: ''
  use_blueprint:
    path: Blackshome/low-battery-notifications-and-actions.yaml
    input:
      include_time: time_enabled
      time: '20:00:00'
      include_easy_notify: enable_easy_notify
      exclude_sensors:
        entity_id:
        - sensor.vaerstasjon_battery_percentage
        - sensor.martes_telefon_battery_level
        - sensor.joel_sin_s24_battery_level
      notify_title: Lav batteri på enheter
      notify_device:
      - e1ea710701e4b194b5c7fdb4676a2030
      notify_message: all_sensors
      weekday_options:
      - sun
      - sat
      - fri
      - thu
      - wed
      - tue
      - mon
- id: '1703956720055'
  alias: 'Varsel: Plastemballasje tømmes'
  description: ''
  trigger:
  - platform: time
    at: 07:00:00
  - platform: time
    at: '19:00:00'
  condition:
  - condition: state
    entity_id: calendar.tommeplan
    attribute: message
    state: Plastemballasje
  - condition: template
    value_template: '{{ as_timestamp(states.calendar.tommeplan.attributes.start_time)
      | timestamp_custom(''%Y-%m-%d'') in [now().strftime(''%Y-%m-%d''), (now() +
      timedelta(days=1)).strftime(''%Y-%m-%d'')] }}'
  action:
  - action: notify.mobile_phones
    data:
      message: Plastemballasje tømmes {% if as_timestamp(states.calendar.tommeplan.attributes.start_time)
        | timestamp_custom('%Y-%m-%d') == now().strftime('%Y-%m-%d') %}i dag.{% else
        %}i morgen.{% endif %}
  mode: single
- id: '1703957259059'
  alias: 'Garasje: Håndtere porten'
  description: ''
  trigger:
  - platform: time
    at: '22:30:00'
    id: natt
  - platform: state
    entity_id:
    - sensor.garageport_humidity
    id: fuktighet
    enabled: true
  - platform: numeric_state
    entity_id:
    - zone.home
    for:
      hours: 0
      minutes: 2
      seconds: 0
    below: 1
    id: borte
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - fuktighet
      - condition: time
        after: 06:00:00
        before: '22:30:00'
      - condition: state
        state: closed
        entity_id: cover.garageport_cover
      - condition: numeric_state
        entity_id: sensor.garageport_humidity
        above: 65
        enabled: true
      sequence:
      - service: button.press
        target:
          entity_id: button.garageport_ventilation
        data: {}
      alias: Fukt over 65%
    - conditions:
      - condition: trigger
        id:
        - fuktighet
      - condition: time
        after: 06:00:00
        before: '22:30:00'
      - condition: template
        value_template: '{{ state_attr(''cover.garageport_cover'', ''current_position'')
          == 4 }}'
        alias: Sjekk hvis ventilasjon posisjon
      - condition: numeric_state
        entity_id: sensor.garageport_humidity
        below: 60
        enabled: true
      sequence:
      - service: cover.close_cover
        data: {}
        target:
          entity_id: cover.garageport_cover
      alias: Fukt under 60%
    - conditions:
      - condition: trigger
        id:
        - borte
        - natt
      sequence:
      - service: cover.close_cover
        data: {}
        target:
          entity_id: cover.garageport_cover
  mode: single
- id: '1703958652880'
  alias: 'TV Stua: Håndtere screens kortvegg'
  description: ''
  triggers:
  - entity_id:
    - sensor.st_00117532_wind_speed_average
    above: 20
    for:
      hours: 0
      minutes: 2
      seconds: 0
    id: mye-vind
    trigger: numeric_state
  - entity_id:
    - sensor.sun_solar_azimuth
    id: azimuth
    trigger: state
  - entity_id:
    - binary_sensor.direct_sunlight_detected
    to: 'on'
    id: det-er-sol
    for:
      hours: 0
      minutes: 2
      seconds: 0
    trigger: state
  - entity_id:
    - binary_sensor.direct_sunlight_detected
    to: 'off'
    for:
      hours: 0
      minutes: 30
      seconds: 0
    id: ingen-sol
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - det-er-sol
        - azimuth
      - condition: state
        entity_id: cover.screen_kortvegg
        state: open
      - condition: numeric_state
        entity_id: sensor.sun_solar_azimuth
        above: 154
        below: 350
      - condition: numeric_state
        entity_id: sensor.st_00117532_wind_speed_average
        below: 20
      - condition: state
        entity_id: binary_sensor.direct_sunlight_detected
        state: 'on'
      sequence:
      - data:
          position: 0
        action: cover.set_cover_position
        target:
          entity_id: cover.screen_kortvegg
    - conditions:
      - condition: trigger
        id:
        - ingen-sol
        - mye-vind
      - condition: state
        entity_id: cover.screen_kortvegg
        state: closed
      sequence:
      - target:
          entity_id: cover.screen_kortvegg
        data:
          position: 100
        action: cover.set_cover_position
  mode: single
- id: '1703959144048'
  alias: 'Felles: Tving Varmepumpene over på varme hvis auto'
  description: ''
  trigger:
  - platform: state
    entity_id:
    - climate.panasonic_ac
    to: heat_cool
    id: inngang
  - platform: state
    entity_id:
    - climate.panasonic_ac_3
    to: heat_cool
    id: stua
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - inngang
      sequence:
      - service: climate.set_hvac_mode
        target:
          entity_id: climate.panasonic_ac
        data:
          hvac_mode: heat
    - conditions:
      - condition: trigger
        id:
        - stua
      sequence:
      - service: climate.set_hvac_mode
        target:
          entity_id: climate.panasonic_ac_3
        data:
          hvac_mode: heat
  mode: single
- id: '1703960225498'
  alias: 'Inngang: Ringeklokke ringelyd på høytalere og varsling'
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.front_door_visitor
    enabled: true
    trigger: state
    id: ding
    to: 'on'
  - trigger: event
    event_type: mobile_app_notification_action
    event_data:
      action: UNLOCK_DOOR
    id: unlock-door
  conditions: []
  actions:
  - alias: Ding ding og send bilde
    if:
    - condition: trigger
      id:
      - ding
    then:
    - parallel:
      - action: browser_mod.popup
        metadata: {}
        data:
          dismissable: true
          autoclose: true
          title: Hoveddør
          timeout: 60000
          browser_id:
          - 0e68cce3acee129263d1cc72ba0a25f9
          content:
            show_state: false
            show_name: false
            camera_view: live
            type: picture-entity
            entity: camera.front_door_fluent
            tap_action:
              action: none
          size: wide
      - sequence:
        - alias: Send med eller uten bilde
          if:
          - condition: state
            entity_id: lock.hoveddor
            state: locked
          then:
          - alias: Send med lås opp action (iOS+Android)
            data:
              data:
                push:
                  interruption-level: critical
                image: https://hast.kaberg.me{{ state_attr('camera.front_door_fluent',
                  'entity_picture') }}
                attachment:
                  url: https://hast.kaberg.me{{ state_attr('camera.front_door_fluent',
                    'entity_picture') }}
                  content-type: jpeg
                  hide-thumbnail: false
                actions:
                - action: UNLOCK_DOOR
                  title: Lås opp hoveddør
                  authenticationRequired: true
                  destructive: true
              message: Noen ringer på døren!
            action: notify.mobile_phones
          else:
          - alias: Send uten action
            data:
              data:
                push:
                  interruption-level: critical
                image: https://hast.kaberg.me{{ state_attr('camera.front_door_fluent',
                  'entity_picture') }}
                attachment:
                  url: https://hast.kaberg.me{{ state_attr('camera.front_door_fluent',
                    'entity_picture') }}
                  content-type: jpeg
                  hide-thumbnail: false
              message: Noen ringer på døren!
            action: notify.mobile_phones
          enabled: false
        enabled: false
  - if:
    - condition: trigger
      id:
      - unlock-door
    - condition: state
      entity_id: lock.hoveddor
      state: locked
    then:
    - action: lock.unlock
      metadata: {}
      data: {}
      target:
        entity_id: lock.hoveddor
    alias: Lås opp hoveddør
  mode: single
- id: '1704022463153'
  alias: 'Kjøkken: Synkronisere taklys med viftelys'
  description: ''
  trigger:
  - platform: state
    entity_id:
    - light.taklys_kjokken
    to: 'on'
    id: 'on'
  - platform: state
    entity_id:
    - light.taklys_kjokken
    to: 'off'
    id: 'off'
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - 'on'
      sequence:
      - service: light.turn_on
        target:
          entity_id: light.kjokken_viftelys
        data: {}
    - conditions:
      - condition: trigger
        id:
        - 'off'
      sequence:
      - service: light.turn_off
        target:
          entity_id: light.kjokken_viftelys
        data: {}
  mode: single
- id: '1704034126221'
  alias: 'Kjøkken: Håndtere ventilator'
  description: Styrer kjøkkenviftemotor og lys basert på platetopp og stekeovn - med
    1.5x kjøretid
  triggers:
  - entity_id: binary_sensor.platetopp
    to: 'on'
    id: platetopp-på
    trigger: state
  - entity_id:
    - binary_sensor.platetopp
    to: 'off'
    id: platetopp-av
    trigger: state
    for:
      hours: 0
      minutes: 5
      seconds: 0
  - entity_id: binary_sensor.stekeovn
    to: 'on'
    id: stekeovn-på
    trigger: state
  - entity_id:
    - binary_sensor.stekeovn
    to: 'off'
    id: stekeovn-av
    trigger: state
    for:
      hours: 0
      minutes: 5
      seconds: 0
  conditions: []
  actions:
  - variables:
      cooking_duration: "{% if trigger.id in ['platetopp-av', 'stekeovn-av'] %}\n
        \ {{ (as_timestamp(trigger.from_state.last_changed) - as_timestamp(trigger.to_state.last_changed))
        | abs }}\n{% else %}\n  0\n{% endif %}\n"
      fan_duration: "{% set min_duration = 15 * 60 %} {% set max_duration = 90 * 60
        %} {% set calculated = (cooking_duration * 1.5) | int %} {% if calculated
        < min_duration %}\n  {{ min_duration }}\n{% elif calculated > max_duration
        %}\n  {{ max_duration }}\n{% else %}\n  {{ calculated }}\n{% endif %}\n"
  - parallel:
    - choose:
      - conditions:
        - condition: trigger
          id:
          - platetopp-på
          - stekeovn-på
        sequence:
        - action: switch.turn_on
          data: {}
          target:
            entity_id: switch.kjokken_vifte
      - conditions:
        - condition: trigger
          id:
          - platetopp-av
          - stekeovn-av
        sequence:
        - delay:
            seconds: '{{ fan_duration }}'
        - target:
            entity_id: switch.kjokken_vifte
          action: switch.turn_off
          data: {}
    - choose:
      - conditions:
        - condition: trigger
          id:
          - platetopp-på
        sequence:
        - target:
            entity_id: light.kjokken_viftelys
          data:
            brightness: 255
          action: light.turn_on
      - conditions:
        - condition: trigger
          id:
          - platetopp-av
        - condition: state
          entity_id: light.taklys_kjokken
          state: 'off'
        sequence:
        - target:
            entity_id: light.kjokken_viftelys
          action: light.turn_off
          data: {}
  mode: restart
- id: '1704054953570'
  alias: 'Internett: veksle av/på'
  description: ''
  triggers:
  - at: 02:00:00
    id: natt
    trigger: time
  - at: 06:00:00
    id: '0600'
    trigger: time
    enabled: true
  - at: 08:30:00
    id: 0830
    trigger: time
    enabled: true
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - natt
      sequence:
      - target:
          entity_id:
          - switch.gw_mgmt_lan_filter_rule_1692694478_homeassistant_block_internet_2
        data: {}
        action: switch.turn_on
      - delay:
          hours: 0
          minutes: 0
          seconds: 5
          milliseconds: 0
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: switch.gw_mgmt_lan_filter_rule_1750072128_homeassistant_block_tvs
    - conditions:
      - condition: trigger
        id:
        - '0600'
      - condition: time
        weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id:
          - switch.gw_mgmt_lan_filter_rule_1750072128_homeassistant_block_tvs
        action: switch.turn_off
      alias: Hvis ukedag og 0830
    - conditions:
      - condition: trigger
        id:
        - '0600'
      - condition: time
        weekday:
        - sat
        - sun
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id:
          - switch.gw_mgmt_lan_filter_rule_1750072128_homeassistant_block_tvs
        action: switch.turn_off
      alias: Hvis helg og 0600
  mode: single
- id: '1704106993941'
  alias: 'Belysning: Håndtere belysning inne og ute'
  description: ''
  triggers:
  - at: 05:30:00
    id: morgen
    trigger: time
  - at: '23:30:00'
    id: natt
    trigger: time
  - event: sunset
    id: sol-ned
    trigger: sun
    offset: -00:15:00
  - event: sunrise
    id: sol-opp
    trigger: sun
    offset: 00:15:00
  - entity_id:
    - zone.home
    for:
      hours: 0
      minutes: 1
      seconds: 0
    below: 1
    id: ingen-hjemme
    trigger: numeric_state
  - trigger: homeassistant
    event: start
    id: hass-start
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - morgen
        - hass-start
      - condition: time
        after: 05:29:00
      - condition: sun
        before: sunrise
      sequence:
      - target:
          entity_id: switch.sunset_sunrise_lights
        data: {}
        action: switch.turn_on
      alias: Skru på morgen lys når det er mørkt ute (vinter tid)
    - conditions:
      - condition: trigger
        id:
        - sol-opp
        - hass-start
      - condition: sun
        after: sunrise
        before: sunset
      sequence:
      - parallel:
        - target:
            entity_id:
            - switch.all_lights
            - switch.alle_utelys
          data: {}
          action: switch.turn_off
        - if:
          - condition: numeric_state
            entity_id: zone.home
            below: 1
          then:
          - data:
              value: 0
              command_class: '38'
              property: targetValue
            target:
              entity_id: "{%- set lights = namespace(entities=[]) %} {%- set light_entities_to_remove
                = [''] %} {%- for entity in integration_entities('zwave_js') if 'light'
                in entity %}\n    {%- if entity not in light_entities_to_remove %}\n
                \       {%- set lights.entities = lights.entities + [entity] %}\n
                \   {%- endif %}\n{%- endfor %} {{ lights.entities | join(',') }}\n"
            action: zwave_js.multicast_set_value
      alias: Det er lyst ute
    - conditions:
      - condition: trigger
        id:
        - sol-ned
        - hass-start
      - condition: sun
        after: sunset
        after_offset: -00:30:00
      sequence:
      - parallel:
        - if:
          - condition: time
            after: 06:00:00
            before: '22:20:00'
          then:
          - metadata: {}
            data: {}
            target:
              entity_id:
              - switch.sunset_sunrise_lights
            action: switch.turn_on
        - metadata: {}
          data: {}
          target:
            entity_id:
            - switch.night_lights
            - switch.alle_utelys
          action: switch.turn_on
      alias: Det er mørkt ute
    - conditions:
      - condition: trigger
        id:
        - natt
        - hass-start
      - condition: time
        after: '23:29:00'
        before: 05:29:00
      sequence:
      - parallel:
        - data:
            value: 0
            command_class: '38'
            property: targetValue
          target:
            entity_id: "{%- set lights = namespace(entities=[]) %} {%- for entity
              in integration_entities('zwave_js') if 'light' in entity %}\n    {%-
              set lights.entities = lights.entities + [entity] %}\n{%- endfor %} {{
              lights.entities | join(',') }}\n"
          action: zwave_js.multicast_set_value
        - target:
            entity_id:
            - switch.sunset_sunrise_lights
            device_id: []
            area_id: []
          data: {}
          action: switch.turn_off
        - target:
            entity_id: light.kjokken_viftelys
          data: {}
          action: light.turn_off
      alias: Det er natt, skru av alle lys utenom i gangen (natt lys)
    - conditions:
      - condition: trigger
        id:
        - ingen-hjemme
        - hass-start
      - condition: numeric_state
        entity_id: zone.home
        below: 1
      sequence:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: switch.alle_taklys
      - data:
          value: 0
          command_class: '38'
          property: targetValue
        target:
          entity_id: "{%- set lights = namespace(entities=[]) %} {%- for entity in
            integration_entities('zwave_js') if 'light' in entity %}\n    {%- set
            lights.entities = lights.entities + [entity] %}\n{%- endfor %} {{ lights.entities
            | join(',') }}\n"
        action: zwave_js.multicast_set_value
        enabled: false
      alias: Skru av taklys når ingen hjemme
  mode: single
- id: '1704108522334'
  alias: 'System: Last inn integrasjon ved feil'
  description: ''
  trigger:
  - platform: time
    at: '15:00:00'
  - platform: time
    at: '18:00:00'
  - platform: time
    at: '21:00:00'
  - platform: time
    at: '23:00:00'
  condition: []
  action:
  - parallel:
    - alias: Sjekk Priceanalyzer
      choose:
      - conditions:
        - condition: template
          value_template: '"{{ state_attr(''sensor.energy_price'', ''prices'') is
            none }}"'
        sequence:
        - service: homeassistant.reload_config_entry
          target:
            entity_id: sensor.priceanalyzer_tr_heim_2
          data: {}
  mode: single
- id: '1704121045304'
  alias: 'System: Håndtere tarif (peak/offpeak)'
  description: ''
  trigger:
  - platform: time
    at: 06:00:00
    id: morgen
  - platform: time
    at: '22:00:00'
    id: natt
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - morgen
      sequence:
      - service: select.select_option
        target:
          entity_id: select.accumulated_energy_hourly2
        data:
          option: peak
      alias: Sett tarif til peak
    - conditions:
      - condition: trigger
        id:
        - natt
      sequence:
      - service: select.select_option
        target:
          entity_id: select.accumulated_energy_hourly2
        data:
          option: offpeak
      alias: Sett tarif til offpeak
  mode: single
- id: '1704266926218'
  alias: 'Varsel: Det er kaldt i kjelleren'
  description: ''
  triggers:
  - entity_id:
    - sensor.kjeller_yttre_sensor_temperature
    - sensor.kjeller_indre_sensor_temperature
    below: 3
    trigger: numeric_state
  conditions: []
  actions:
  - action: notify.mobile_app_sm_s911b
    metadata: {}
    data:
      message: Det er nå {{ trigger.to_state }}°C i kjelleren.
  mode: single
- id: '1704268362920'
  alias: 'Varsel: Nedbør og takvinduer'
  description: ''
  trigger:
  - platform: state
    entity_id:
    - weather.hjem
  condition:
  - condition: template
    value_template: '{{ states.weather.hjem.state in [''hail'', ''lightning'', ''lightning-rainy'',
      ''pouring'', ''rainy'', ''snowy'', ''snowy-rainy''] }}'
  action:
  - variables:
      open_windows: "{%- set windows = namespace(devices='') %} {%- for device in\n
        \ ['binary_sensor.loftstue_takvindu_nord_contact',\n  'binary_sensor.loftstue_takvindu_sor_contact',\n
        \ 'binary_sensor.trapp_takvindu_contact'] %}\n    {%- if is_state(device,
        'on') %}\n      {%- if windows.devices == '' %}\n        {%- set windows.devices
        = state_attr(device, 'friendly_name') %}\n      {%- else %}\n        {%- set
        windows.devices = windows.devices + ', ' + state_attr(device, 'friendly_name')
        %}\n      {%- endif %}\n    {%- endif %}\n  {%- endfor %} {{ windows.devices
        }}\n"
  - if:
    - condition: template
      value_template: '{{ True if open_windows is not None else False }}'
    then:
    - parallel:
      - service: notify.varsle_telefoner
        data:
          title: Lukk takvinduer!
          message: '{{ open_windows }} er åpne, og det er meldt nedbør.'
      - if:
        - condition: state
          entity_id: group.someone_home
          state: home
        - condition: time
          after: 08:00:00
          before: '22:00:00'
        then:
        - service: tts.speak
          data:
            cache: true
            message: '{{ open_windows }} er åpne, og det er meldt nedbør.'
            media_player_entity_id: media_player.gminis
- id: '1704269708255'
  alias: 'Varsel: Når billader er utilgjengelig'
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.garasje_online
    to: 'off'
    trigger: state
  conditions: []
  actions:
  - data:
      message: 'KRITISK: Billader er utilgjengelig!'
    action: notify.mobile_app_joel_sin_s24
  mode: single
- id: '1704269856111'
  alias: 'Dører: Håndtere låsene'
  description: ''
  triggers:
  - at: 06:30:00
    id: morgen
    trigger: time
  - at: '22:30:00'
    id: natt
    trigger: time
  - entity_id:
    - zone.home
    above: 0
    id: hjemme
    alias: Noen er hjemme
    trigger: numeric_state
  - entity_id:
    - zone.home
    below: 1
    id: ingen-hjemme
    alias: Ingen er hjemme
    trigger: numeric_state
  - trigger: homeassistant
    event: start
    id: hass-start
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - morgen
        - hjemme
        - hass-start
      - condition: numeric_state
        entity_id: zone.home
        above: 0
      - condition: time
        after: 06:00:00
        before: '22:29:00'
      sequence:
      - sequence:
        - target:
            device_id: []
            area_id: []
            entity_id:
            - switch.hoveddor_auto_relock
            - switch.kjellerdor_auto_relock
          data: {}
          action: switch.turn_off
        - delay:
            hours: 0
            minutes: 0
            seconds: 5
            milliseconds: 0
        - target:
            entity_id:
            - lock.hoveddor
            - lock.kjellerdor
          data: {}
          action: lock.unlock
      alias: Det er morgen og/eller noen hjemme
    - conditions:
      - condition: trigger
        id:
        - ingen-hjemme
        - natt
        - hass-start
      - condition: or
        conditions:
        - condition: numeric_state
          entity_id: zone.home
          below: 1
        - condition: time
          after: '22:29:00'
      sequence:
      - sequence:
        - target:
            device_id: []
            area_id: []
            entity_id:
            - switch.hoveddor_auto_relock
            - switch.kjellerdor_auto_relock
          data: {}
          action: switch.turn_on
        - delay:
            hours: 0
            minutes: 0
            seconds: 5
            milliseconds: 0
        - target:
            entity_id:
            - lock.hoveddor
            - lock.kjellerdor
          data: {}
          action: lock.lock
      alias: Ingen hjemme eller det er natt
  mode: single
- id: '1704280361008'
  alias: 'Garasje: Håndtere elbillader'
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.billader_lav_strompris
    id: lavpris-on
    trigger: state
    to: 'on'
  - entity_id:
    - binary_sensor.billader_lav_strompris
    id: lavpris-off
    trigger: state
    to: 'off'
  - entity_id:
    - input_boolean.force_evcharge
    id: force-on
    to: 'on'
    trigger: state
  - entity_id:
    - input_boolean.force_evcharge
    to: 'off'
    id: force-off
    trigger: state
  - entity_id:
    - switch.garasje_is_enabled
    to: 'on'
    id: billader-aktiv
    trigger: state
  - minutes: /5
    id: minute-trigger
    trigger: time_pattern
  - entity_id:
    - sensor.garasje_status
    id: garasje-status
    trigger: state
  conditions:
  - condition: state
    entity_id: input_boolean.away_mode
    state: 'off'
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - billader-aktiv
        - minute-trigger
      - condition: state
        entity_id: switch.garasje_is_enabled
        state: 'on'
      - alias: No action for the first 5 minutes of an hour
        condition: template
        value_template: '{{ now().minute >= 5 }}'
      - condition: template
        value_template: '{{ states.sensor.garasje_status.state in [''awaiting_start'',
          ''ready_to_charge'', ''charging''] }}'
      sequence:
      - data:
          charger_id: EHCQPVGQ
          current: '{%- set limits = [0, 6, 10, 13, 16, 20, 25, 32] %}  {%- set consumption
            = states.sensor.energy_estimate_this_hour.state | float(0) %}  {%- set
            treshold = states.input_select.energy_tariff.state | float(0) - 0.6 %}
            {%- set remaining_current = (((treshold - consumption) + states.sensor.garasje_power.state
            | float(0)) * 1000) / 230 %}  {%- set limiter = limits | select(''le'',remaining_current)  |
            list | max %} {{ limiter if limiter > 0 else 0 }}

            '
        action: easee.set_charger_dynamic_limit
      alias: Justere strømstyrke på billader etter grenseverdi
    - conditions:
      - condition: trigger
        id:
        - lavpris-on
        - force-on
      - condition: template
        value_template: '{{ states.sensor.garasje_status.state in [''awaiting_start'',
          ''ready_to_charge'', ''charging''] }}'
      sequence:
      - target:
          entity_id: switch.garasje_is_enabled
        data: {}
        action: switch.turn_on
      alias: Skru på billader
    - conditions:
      - condition: trigger
        id:
        - lavpris-off
        - force-off
      sequence:
      - parallel:
        - target:
            entity_id: switch.garasje_is_enabled
          data: {}
          action: switch.turn_off
        - data:
            charger_id: EHCQPVGQ
            current: 0
          action: easee.set_charger_dynamic_limit
      alias: Skru av billader
    - conditions:
      - condition: trigger
        id:
        - garasje-status
      - condition: or
        conditions:
        - condition: state
          entity_id: binary_sensor.billader_lav_strompris
          state: 'on'
        - condition: state
          entity_id: input_boolean.force_evcharge
          state: 'on'
      sequence:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: switch.garasje_is_enabled
  mode: single
- id: '1704291389386'
  alias: 'Vaskerom: Håndtere VVB'
  description: ''
  triggers:
  - value_template: '{{ states.sensor.energy_used_this_hour.state | float(0) >= (states.sensor.energy_level_upper_threshold.state
      | float(0) - 0.4) }}'
    alias: Sjekk om forbruk overstiger nåværende kapasitetsledd
    id: hoyt-forbruk
    trigger: template
    enabled: false
  - entity_id:
    - sensor.vaskerom_vvb_setpoint
    id: endre-temp
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - hoyt-forbruk
      sequence:
      - target:
          entity_id: climate.varmtvannsbereder
        data:
          temperature: 45
        action: climate.set_temperature
    - conditions:
      - condition: trigger
        id:
        - endre-temp
      sequence:
      - target:
          entity_id: climate.varmtvannsbereder
        data:
          temperature: '{{ states(''sensor.vaskerom_vvb_setpoint'') | int }}

            '
        action: climate.set_temperature
  mode: single
- id: '1704299027912'
  alias: 'Inngang: Håndtere MagicMirror'
  description: ''
  triggers:
  - alias: Bevegelse
    trigger: state
    entity_id:
    - binary_sensor.bevegelsessensor_any_movement
    id: bevegelse
    to:
    - 'on'
  - alias: Stille
    trigger: state
    entity_id:
    - binary_sensor.bevegelsessensor_any_movement
    id: stille
    for:
      hours: 0
      minutes: 1
      seconds: 0
    to:
    - 'off'
  - trigger: event
    event_type: lovelace_updated
    id: Reload
    enabled: true
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - bevegelse
      sequence:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: switch.magicmirror_screen
    - conditions:
      - condition: trigger
        id:
        - stille
      sequence:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: switch.magicmirror_screen
    - conditions:
      - condition: trigger
        id:
        - Reload
      sequence:
      - action: button.press
        metadata: {}
        data: {}
        target:
          entity_id: button.magicmirror_load_start_url
  mode: restart
- id: '1704545461083'
  alias: 'Loftstue: Skru av ved bruk over 1t'
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.loftstue_on_duration_today
  - platform: state
    entity_id:
    - media_player.loftstue_2
  condition:
  - condition: state
    entity_id: input_boolean.skjermtid_loftstue
    state: 'on'
  action:
  - parallel:
    - alias: Skru av?
      if:
      - condition: state
        entity_id: media_player.loftstue_2
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.loftstue_on_duration_today
        above: 0.59
      then:
      - service: media_player.turn_off
        target:
          entity_id: media_player.loftstue_2
        data: {}
      - wait_for_trigger: []
        timeout:
          hours: 0
          minutes: 0
          seconds: 4
          milliseconds: 0
        continue_on_timeout: false
    - if:
      - condition: numeric_state
        entity_id: sensor.loftstue_on_duration_today
        above: 0.54
        below: 0.56
      then:
      - service: notify.loftstue
        data:
          title: Skjermtid
          message: Det er 5 minutter igjen!
          data:
            position: center
            fontsize: max
            color: red
            duration: 7
      alias: Varsle
  mode: single
- id: '1705167976713'
  alias: 'Varsel: Batteri Værstasjon lav'
  description: ''
  triggers:
  - entity_id:
    - sensor.st_00117532_battery_voltage
    trigger: state
  conditions:
  - condition: numeric_state
    entity_id: sensor.st_00117532_battery_voltage
    below: 2.15
  actions:
  - data:
      message: 'KRITISK: Batteri nivå på Værstasjon er lav.'
    action: notify.mobile_app_sm_s911b
  mode: single
- id: '1726424071044'
  alias: 'Varsel: Når en dørlås blir utilgjengelig'
  description: ''
  triggers:
  - entity_id:
    - lock.hoveddor
    - lock.kjellerdor
    to: unavailable
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  actions:
  - action: notify.mobile_app_joel_sin_s24
    metadata: {}
    data:
      message: '{{ trigger.to_state.attributes.friendly_name }} er utilgjengelig.'
- id: '1736196311850'
  alias: 'Smilfjes: Håndtere poeng ift barna'
  description: ''
  triggers:
  - trigger: time
    at: 00:00:00
  conditions: []
  actions:
  - if:
    - condition: time
      weekday:
      - sun
    then:
    - action: input_number.set_value
      metadata: {}
      data:
        value: 0
      target:
        entity_id:
        - input_number.jonas_uke_karakter
        - input_number.sofie_uke_karakter
        - input_number.markus_uke_karakter
  - alias: Er alle oppgaver gjort av dagens hjelper?
    if:
    - condition: template
      value_template: '{% set items = state_attr(''todo.dagens_hjelper'', ''items'')
        %}

        {% set uncompleted = items | selectattr(''status'', ''eq'', ''needs_action'')
        | list %}

        {{ uncompleted | length == 0 and items | length > 0 }}'
      alias: Sjekk om alle oppgaver er gjort
    then:
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ now().day % 3 == 0 }}'
          alias: Jonas?
        sequence:
        - action: input_number.increment
          metadata: {}
          data: {}
          target:
            entity_id: input_number.jonas_uke_karakter
      - conditions:
        - alias: Sofie?
          condition: template
          value_template: '{{ now().day % 3 == 1 }}'
        sequence:
        - action: input_number.increment
          metadata: {}
          data: {}
          target:
            entity_id:
            - input_number.sofie_uke_karakter
        alias: Sofie?
      - conditions:
        - alias: Markus?
          condition: template
          value_template: '{{ now().day % 3 == 1 }}'
        sequence:
        - action: input_number.increment
          metadata: {}
          data: {}
          target:
            entity_id: input_number.markus_uke_karakter
        alias: Markus?
      alias: Gi poeng!
  - action: todo.update_item
    metadata: {}
    data:
      item: '{{ state_attr(''todo.dagens_hjelper'', ''items'') | map(attribute=''uid'')
        | list }}'
      status: needs_action
    target:
      entity_id: todo.dagens_hjelper
  mode: single
- id: '1737453210073'
  alias: 'Varsel: UPS mottar ikke strøm'
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.dataskap_input_voltage
    below: 200
  conditions: []
  actions:
  - action: notify.mobile_app_joel_sin_s24
    data:
      message: 'KRITISK: UPSen mottar ikke strøm.'
  mode: single
- id: '1739133998450'
  alias: 'Belysning: Skru av alle taklys ved dobbelpress på inngang taklys'
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - event.taklys_inngang_scene_001
  conditions:
  - condition: state
    entity_id: event.taklys_inngang_scene_001
    attribute: event_type
    state: KeyPressed2x
  actions:
  - action: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.alle_taklys
  mode: single
- id: '1748870416530'
  alias: 'Teknisk: Håndtere Waterguard'
  description: ''
  triggers:
  - trigger: time
    at: 03:00:00
    id: monthly
  - trigger: state
    entity_id:
    - binary_sensor.vannlekasje_sensorer
    to: 'on'
    id: vannlekasje
  conditions: []
  actions:
  - alias: Månedelig syklus
    if:
    - condition: trigger
      id:
      - monthly
    - condition: template
      value_template: '{{ now().day == 1 }}      '
    then:
    - action: switch.turn_on
      metadata: {}
      data: {}
      target:
        entity_id: switch.waterguard
    - delay:
        hours: 0
        minutes: 0
        seconds: 5
        milliseconds: 0
    - action: switch.turn_off
      metadata: {}
      data: {}
      target:
        entity_id: switch.waterguard
  - alias: Skru av vann ved lekasje
    if:
    - condition: trigger
      id:
      - vannlekasje
    then:
    - action: switch.turn_on
      metadata: {}
      data: {}
      target:
        entity_id: switch.waterguard
    - action: notify.mobile_phones
      metadata: {}
      data:
        message: Vannlekasje oppdaget, vannet er skrudd av.
  mode: single
- id: '1748935599662'
  alias: 'Varsel: Når Oppvaskm. tørketrommel og vaskemaskin er ferdig'
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.oppvaskmaskin
    to: program_ended
    enabled: true
    for:
      hours: 0
      minutes: 1
      seconds: 0
    from: in_use
  - trigger: state
    entity_id:
    - binary_sensor.vaskemaskin
    to: 'off'
    from: 'on'
    enabled: true
    for:
      hours: 0
      minutes: 5
      seconds: 0
  - trigger: state
    entity_id:
    - sensor.torketrommel_program_finished
    for:
      hours: 0
      minutes: 2
      seconds: 0
    enabled: true
    to:
    - confirmed
  conditions: []
  actions:
  - action: notify.mobile_phones
    metadata: {}
    data:
      message: '{{ state_attr(trigger.entity_id, ''friendly_name'') }} er ferdig!'
  - if:
    - condition: time
      after: 07:00:00
      before: '22:30:00'
    - condition: numeric_state
      entity_id: zone.home
      above: 0
    then:
    - action: tts.speak
      target: {}
      data:
        cache: true
        message: '{{ state_attr(trigger.entity_id, ''friendly_name'') }} er ferdig!'
        media_player_entity_id: media_player.nestmini7392
  mode: single
- id: '1761052079403'
  alias: 'Overvåkning: Håndtere driveway kamera'
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.utendor_bevegelse_sensor_occupancy
    to: 'on'
    id: bevegelse-garasje
    for:
      hours: 0
      minutes: 0
      seconds: 2
  conditions: []
  actions:
  - if:
    - condition: trigger
      id:
      - bevegelse-garasje
    - condition: state
      entity_id: binary_sensor.driveway_bevegelse
      state: 'off'
    then:
    - action: select.select_option
      metadata: {}
      data:
        option: Utenfor garasjen
      target:
        entity_id: select.driveway_ptz_preset
  mode: single
- id: '1761730691090'
  alias: 'Varslel: Kjellerdør åpen i 5 min'
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.kjeller_kjellerdor_contact
    to: 'on'
    for:
      hours: 0
      minutes: 5
      seconds: 0
  conditions: []
  actions:
  - repeat:
      until:
      - condition: state
        entity_id: binary_sensor.kjeller_kjellerdor_contact
        state: 'off'
      sequence:
      - data:
          title: Kjellerdør åpen!
          message: Kjellerdør er åpen, lukk den.
        action: notify.mobile_phones
      - data:
          cache: true
          message: Kjellerdør er åpen, lukk den.
          media_player_entity_id: media_player.gminis
        action: tts.speak
  mode: single
- id: '1762246250400'
  alias: 'Trapp: Dobbeltrykk trapp dimmer for og slukk taklyset på loftet'
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - event.taklys_trapp_scene_001
  conditions:
  - condition: state
    entity_id: event.taklys_trapp_scene_001
    attribute: event_type
    state: KeyPressed2x
  actions:
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - light.taklys_kontor
      - light.taklys_loftstue
  mode: single
- id: '1762273570357'
  alias: 'Kjokken: Dobbel trykk dimmer slukker 2 etasje taklys'
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - event.taklys_kjokken_scene_001
  conditions:
  - condition: state
    entity_id: event.taklys_kjokken_scene_001
    attribute: event_type
    state: KeyPressed2x
  actions:
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - light.taklys_kjokken
      - light.taklys_stue
      - light.taklys_tv_stue
  mode: single
